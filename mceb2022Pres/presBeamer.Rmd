---
title: "Assessing the effect of date and sequence data in phylodynamics"
author: "Leo A. Featherstone"
date: "`r Sys.Date()`"
output: beamer_presentation
colortheme: "beaver"
incremental: true
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library('plotly')
library('tidyverse')
library('viridis')
library(reshape)
library(cowplot)
library(latex2exp)
library(ggpmisc)
library(ggExtra)
library(DiagrammeR)
library(lubridate)

setwd('~/Desktop/phyloDataSignal/mceb2022Pres')
```
 
## About me
-   PhD candidate (2021-2024) @ University of Melbourne Peter Doherty Institute
\begin{center}
\includegraphics[width=0.5\textwidth]{figs/dohertyMelb.png}
\end{center}
-   Working with Dr. Sebastian Duchene, Dr. Timothy Vaughan, and Prof. Ben Phillips
- [Twitter: @LeoPhylostone](https://twitter.com/LeoPhylostone)

<!-- Include twitter and git links and pictures -->

## Core content
\begin{center}
  \includegraphics[width=0.5\textwidth]{../figures/graphicalMethods}
\end{center}
- [Preprint: Assessing the effects of date and sequence data in phylodynamics](https://www.biorxiv.org/content/10.1101/2022.06.07.495205v1)
- Under birth-death with serial sampling $(\lambda, \delta, p)$

## Talk breakdown
1.    Origins of project
2.    Quantify data and sequence effects under birth-death model
3.    Validation
4.    Context

## Project origins (SARS-CoV-2 in Australia)
```{r include=FALSE, exexute=F}
#detach("package:GISAIDR", unload=TRUE)
#devtools::install_github("Wytamma/GISAIDR")
#library(GISAIDR)
#username = Sys.getenv("GISAIDR_USERNAME")
#password = Sys.getenv("GISAIDR_PASSWORD")
#credentials <- login(username = username, password = password)
# 08/06/2020
#df <- data.frame()
#for (i in 0:ceiling(41818/50)){
#  num = 50*i+i
#  df <- rbind(df, query(credentials = credentials, location = 'Australia', from='2021-01-01', to='2021-12-31', start_index = num))
#}
#backup <- df
# user timed out 
#username = Sys.getenv("GISAIDR_USERNAME")
#password = Sys.getenv("GISAIDR_PASSWORD")
#credentials <- login(username = username, password = password)
#for (i in 504:ceiling(41818/50)){
#  num = 50*i+i
#  df <- rbind(df, query(credentials = credentials, location = 'Australia', from='2021-01-01', to='2021-12-31', start_index = num))
#}

## load sample data
load('gisaid2022Sampling.RData')
# remove duplicates and format dates
samp <- df %>% distinct(accession_id,.keep_all = TRUE)
# samp counts
samp$collection_date <- as.Date(samp$collection_date)
samp <- samp %>% group_by(collection_date) %>% summarise(count = n()) 

## get case traj
case <- read.csv('owid-covid-data.csv', header=T)
case <- case[which(case$location == 'Australia'),] %>% select(date, new_cases)
case$date <- as.Date(case$date)
case <- case[case$date >= as.Date("2021-01-01") & case$date <= as.Date("2021-12-31"),]

# bind and add sampling proportion
colnames(samp)[1] <- 'date'
case$date <- as.Date(case$date)

dat <- full_join(samp, case, by='date') %>% mutate(nSamp = cumsum(count), new=cumsum(new_cases)) %>% select(date, new, nSamp)
dat1 <- pivot_longer(dat, cols=c('nSamp', 'new'))

# early
p1 <- ggplot(dat1) + 
      geom_step(aes(x=date, y=value, col=name)) +
      geom_step(data=dat, aes(x=date, y=2500*nSamp/new), col='dodgerblue') +
      scale_x_date('', labels=scales::date_format("%b %Y"), limits = as.Date(c('2021-01-01', '2021-06-30'))) +
      scale_y_continuous('Cumulative Cases or Samples',limits=c(0,2500), sec.axis = sec_axis(~ . * (1/2500), name = 'Cumulative Sampling Proportion')) +
      scale_color_manual(values=c('black', 'red'), labels=c('Cumulative Cases', 'Cumulative Sequences')) +
      theme_minimal() +
      theme(legend.position = 'bottom',
            legend.title = element_blank(),
            axis.text.y.right = element_text(color = "dodgerblue"),
            axis.title.y.right = element_text(color = "dodgerblue"))

pdf('figs/early2021SampEg.pdf', useDingbats=F, width=5, height=4)
  p1
dev.off()

scientific_10 <- function(x) {
  parse(text=gsub("e\\+", " %*% 10^", scales::scientific_format()(x)))
}

library(ggforce)

# whole timespan
p2 <- ggplot(dat1) + 
      geom_step(aes(x=date, y=value, col=name)) +
      geom_step(data=dat, aes(x=date, y=400000*nSamp/new), col='dodgerblue') +
      scale_x_date('', labels=scales::date_format("%b %Y"), limits = as.Date(c('2021-01-01', '2021-12-31'))) +
      scale_y_continuous('Cumulative Cases or Samples',limits=c(0,400000), sec.axis = sec_axis(~ . * (1/400000), name = 'Cumulative Sampling Proportion'), labels = scientific_10) +
      scale_color_manual(values=c('black', 'red'), labels=c('Cumulative Cases', 'Cumulative Sequences')) +
      annotate('segment', x=as.Date(c('2021-01-01','2021-06-30')), y=c(0,0), xend=as.Date(c('2021-02-01', '2021-05-30')), yend=c(2e+5,2e+5)) +
      theme_minimal() +
      theme(legend.position = 'bottom',
            legend.title = element_blank(),
            axis.text.y.right = element_text(color = "dodgerblue"),
            axis.title.y.right = element_text(color = "dodgerblue"))

p1prime <- ggplot(dat1) + 
      geom_step(aes(x=date, y=value, col=name)) +
      geom_step(data=dat, aes(x=date, y=2500*nSamp/new), col='dodgerblue') +
      scale_x_date('', labels=scales::date_format("%b %Y"), limits = as.Date(c('2021-01-01', '2021-06-30'))) +
      scale_y_continuous('',limits=c(0,2500), sec.axis = sec_axis(~ . * (1/2500), name = '')) +
      scale_color_manual(values=c('black', 'red'), labels=c('Cumulative Cases', 'Cumulative Sequences')) +
      #theme_minimal() +
      theme(legend.position = 'none',
            legend.title = element_blank(),
            axis.text.y.right = element_text(color = "dodgerblue"),
            axis.title.y.right = element_text(color = "dodgerblue"),
            axis.text.x = element_blank())


pdf('figs/whole2021SampEg.pdf', useDingbats=F, width=5, height=4)
  p2 + annotation_custom(ggplotGrob(p1prime), xmin = as.Date('2021-01-01'), xmax = as.Date('2021-06-30'), ymin = 0.5e+5, ymax = 2e+5)
dev.off()



```
\begin{figure}
\centering
\includegraphics[height=0.9\textheight]{figs/early2021SampEg.pdf}
<!--\caption{Cumulative sampling and case trajectory from early 2021 in Australia.}-->
\end{figure}

## Project origins: literature
- Volz et al. 2014 $\rightarrow$ sampling times heavily influential under BD
- Featherstone et al. 2021 $\rightarrow$ sampling times help prevent bias

## Sapareting sequence and dates

|           |   Dates Included      | Dates Excluded    |
|-------|-------|-------|
|Sequence Included   |  Combined effect   | Sequence Effects |
|Sequence Excluded | Date effects    | Marginal Prior  |

## Separating sequence and dates: an example
```{r include=FALSE}
fullData <- 'Full Data (F)\n>Sample1_01-01-2020\nACGTATCGTATCATAC...\n>Sample2_02-02-2020\nAGGTATCGTATCATAC...\n>Sample3_03-03-2020\nATCACATCGTATATAC...'
seqData <- 'Sequence Only (S)\n>Sample1_??-??-????\nACGTATCGTATCATAC...\n>Sample2_??-??-????\nAGGTATCGTATCATAC...\n>Sample3_??-??-????\nATCACATCGTATATAC...\n\n(feast BEAST v2 package)'
dateData <- 'Dates Only (D)\n>Sample1_01-01-2020\nNNNNNNNNNNNN...\n>Sample2_02-02-2020\nNNNNNNNNNNNN...\n>Sample3_03-03-2020\nNNNNNNNNNNNN...'
noData <- 'Marginal Prior (N)\n>Sample1_??-??-????\nNNNNNNNNNNNN...\n>Sample2_??-??-????\nNNNNNNNNNNNN...\n>Sample3_??-??-????\nNNNNNNNNNNNN...'

fig <-  grViz("
          digraph a_nice_graph {
          
          # node definitions with substituted label text
          node [shape = box, fontname = Helvetica]
          a [label = '@@1']
          b [label = '@@2-1']
          c [label = '@@2-2']
          d [label = '@@2-3']
          
          # edge definitions with the node IDs
          a -> {b c d}
          }
          
          [1]: fullData
          [2]: c(dateData, seqData, noData)
        ")

fig = DiagrammeRsvg::export_svg(fig)
fig = charToRaw(fig) # flatten
rsvg::rsvg_pdf(fig, "figs/dataSepAln.pdf")
```
![Isolating date and sequence data.](figs/dataSepAln.pdf)\

## Output
![.](../figures/postEg.pdf)

## Comparing possterior signal cont.
```{r include=FALSE}

dists <- ggplot(data = data.frame(x = c(0, 4)), aes(x)) +
  stat_function(fun = dnorm, n = 10000, args = list(mean = 1.5, sd = 0.2), 
  	fill=alpha(viridis::viridis(4)[1], 0.5), geom='density') +
  # fulldata
  stat_function(fun = dnorm, n = 10000, args = list(mean = 2.5, sd = 0.2), 
  	fill=alpha(viridis::viridis(4)[2], 0.5), geom='density') +
  # no data
  stat_function(fun = dgamma, n = 10000, args = list(shape = 3.5, rate = 2.5), 
  	fill=alpha(viridis::viridis(4)[3], 0.5), geom='density') + ylab("") +
  # seq data
  stat_function(fun = dnorm, n = 10000, args = list(mean = 3, sd = 0.2), 
  	fill=alpha(viridis::viridis(4)[4], 0.5), geom='density') +

  # wasserstein
  annotate("segment", x = 2.51, xend = 3, y = 1.5, yend = 1.5,
           colour = "black", arrow = arrow(ends = "both", angle = 90, length = unit(.2,"cm"))) +
  annotate("label", x = 2.75, y = 1.5, colour = "black", label='W[S]==0.5', parse=T) +

  annotate("segment", x = 1.5, xend = 2.49, y = 1.5, yend = 1.5,
           colour = "black", arrow = arrow(ends = "both", angle = 90, length = unit(.2,"cm"))) +
  annotate("label", x = 2, y = 1.5, colour = "black", label='W[D]==1.0', parse=T) +

  annotate("segment", x = 1, xend = 2.49, y = 0.4, yend = 0.4,
           colour = "black",arrow = arrow(ends = "both", angle = 90, length = unit(.2,"cm"))) +
  annotate("label", x = 1.75, y = 0.4, colour = "black", label='W[N]==1.15', parse=T) +

  annotate("label", x = 0.6, y = 1, colour = "black", label='W[X]==integral(paste("| ", F[X]^-1*(u)-F[F]^-1*(u), " |")*du, 0, 1)', parse=T) +
  annotate("label", x = 3.5, y = 1, colour = "black", label='W[D]>W[S]%->%Seq~Driven', parse=T) +
  xlab(TeX('Posterior $R_{0}$')) + ylab('Density') + 
  coord_fixed() +
  theme_minimal() +
		theme(legend.position='bottom', 
			legend.title=element_text(size=14),
			legend.text=element_text(size=14), 
			axis.title=element_text(size=14))

pdf('figs/compPosterior.pdf', useDingbats = F, width=8, height=4)
  dists
dev.off()

df <- data.frame(Data=c(rep('Date Data',10000), rep('Full Data', 10000), rep('Marginal Prior', 10000), rep('Sequence Data', 10000)),
                 x=c(rnorm(n=10000, mean = 1.5, sd = 0.2),
                     rnorm(n=10000, mean = 2.5, sd = 0.2),
                     rgamma(n=10000, shape=3.5, rate = 2.5),
                     rnorm(n=10000, mean = 3, sd = 0.2)))

dists2 <- ggplot(data = df, aes(x=x, fill=Data)) +
    geom_density() +
     annotate("segment", x = 2.51, xend = 3, y = 1.5, yend = 1.5,
             colour = "black", arrow = arrow(ends = "both", angle = 90, length = unit(.2,"cm"))) +
    annotate("label", x = 2.75, y = 1.5, colour = "black", label='W[S]==0.5', parse=T) +
  
    annotate("segment", x = 1.5, xend = 2.49, y = 1.5, yend = 1.5,
             colour = "black", arrow = arrow(ends = "both", angle = 90, length = unit(.2,"cm"))) +
    annotate("label", x = 2, y = 1.5,  label='W[D]==1.0', parse=T) +
  
    annotate("segment", x = 1, xend = 2.49, y = 0.4, yend = 0.4,
             colour = "black",arrow = arrow(ends = "both", angle = 90, length = unit(.2,"cm"))) +
    annotate("label", x = 1.75, y = 0.4, colour = "black", label='W[N]==1.15', parse=T) +
  
    annotate("label", x = 0.6, y = 1, colour = "black", label='W[X]==integral(paste("| ", F[X]^-1*(u)-F[F]^-1*(u), " |")*du, 0, 1)', parse=T) +
    annotate("label", x = 3.5, y = 1, colour = "black", label='W[D]>W[S]%->%Seq~Driven', parse=T) +
  xlim(0,4) +
  scale_fill_manual(values=alpha(viridis(4), 0.5)) +
    xlab(TeX('Posterior $R_{0}$')) + ylab('Density') + 
    coord_fixed() +
    theme_minimal() +
  		theme(legend.position='bottom', 
  			legend.title=element_blank(),
  			legend.text=element_text(size=14), 
  			axis.title=element_text(size=14))


pdf('figs/compPosterior.pdf', useDingbats = F, width=8, height=4)
  dists2
dev.off()

```
\centering
\includegraphics[width=0.9\textheight]{figs/compPosterior.pdf}

## Wasserstein Intuition (in 1D)
```{r include=FALSE}
# cdf comp figure
df <- data.frame(
  x = c(abs(rnorm(n=100, mean=1, sd=0.5)), rnorm(n=100, mean=2, sd=0.5)),
  g = gl(2, 100)
)

horiz <- data.frame(
  x1 = quantile(df[which(df$g==1),]$x, c(seq(0,1, by=0.1))),
  x2 = quantile(df[which(df$g==2),]$x, c(seq(0,1, by=0.1))),
  y1 = seq(0,1, by=0.1),
  y2 = seq(0,1, by=0.1)
)

hist <- ggplot(df, aes(x, fill = g)) + geom_histogram(position='identity', stat='density') +
        scale_fill_manual(values=alpha(viridis(4)[1:2], 0.7)) +
        xlab(expression(R[0])) + ylab('Posterior Density') +
        theme_minimal() +
        theme(legend.position = 'none')

fig <- ggplot(df, aes(x, colour = g)) +
        annotate("rect", xmin = horiz$x1, xmax=horiz$x2, ymin = horiz$y1, ymax=horiz$y2+0.1, fill='grey', alpha=0.5) +
        stat_ecdf(size=1.2) +
        scale_color_manual(values=viridis(4)[1:2]) +
        annotate("segment", x = horiz$x1, y = horiz$y1, xend = horiz$x2, yend = horiz$y2, lty=2) +
        annotate("label", x = (horiz$x1+horiz$x2)/2, y = horiz$y1, label=paste0('d[',0:10,']'), parse=T, size=2.5) +
        annotate("label", x = 0.5, y = 0.75, label='W[D]==sum(frac(1,10)*d[i],"","")', parse=T, size=2.5, fill=alpha(viridis(4)[4], 0.7)) +
        xlab(expression(R[0])) + ylab('CDF') +
        theme_minimal() +
        theme(legend.position = 'none')

pdf('figs/wassersteinIntuition.pdf', useDingbats = F, width=4, height=3)
  fig
dev.off()

```
How much **work** to push one distribution into another?
<!-- - $$ W_D = \int_0^1 |F_{D}^{-1}(u)-F_{F}^{-1}(u)| \; du $$ -->
![Notionally, W is the sum of difference between quantiles.](figs/wassersteinIntuition.pdf)

## Some examples
```{r include=FALSE}

fig1 <- ggplot(data = data.frame(x = c(-5, 5)), aes(x)) +
          stat_function(fun = dnorm, n = 101, args = list(mean = 0, sd = 1), col='red') + ylab("") +
          stat_function(fun = dnorm, n = 101, args = list(mean = 0.2, sd = 1), col='blue') + ylab("") +
          xlab(TeX('$R_0$')) + ylab('Density') +
          annotate('text', label='W%->%0', x=-3, y=0.35, parse=T, size=2.5) +
          theme_minimal() + 
          theme(axis.text.x = element_text(angle = 60, hjust=1))
fig2 <- ggplot(data = data.frame(x = c(-5, 5)), aes(x)) +
          stat_function(fun = dnorm, n = 101, args = list(mean = 0, sd = 1), col='red') + ylab("") +
          stat_function(fun = dnorm, n = 101, args = list(mean = 3, sd = 1), col='blue') + ylab("") +
          xlab(TeX('$R_0$')) + ylab('') +
          annotate('text', label='W=3', x=-3, y=0.35, size=2.5 ) +
          theme_minimal() + 
          theme(axis.text.x = element_text(angle = 60,  hjust=1))
# transport::wasserstein1d(rnorm(n=1000, mean=0, sd=1), rnorm(n=1000, mean=0, sd=0.5)) = 0.4165063

fig3 <- ggplot(data = data.frame(x = c(-5, 5)), aes(x)) +
          stat_function(fun = dnorm, n = 101, args = list(mean = 0, sd = 1), col='red') + ylab("") +
          stat_function(fun = dnorm, n = 101, args = list(mean = 0, sd = 0.5), col='blue') + ylab("") +
          xlab(TeX('$R_0$')) + ylab('Density') +
          annotate('text', label='W%~~%0.4', x=-3, y=0.6,  parse=T, size=2.5) +
          theme_minimal() + 
          theme(axis.text.x = element_text(angle = 60,  hjust=1))

# transport::wasserstein1d(rnorm(n=1000, mean=0, sd=2.5), rnorm(n=1000, mean=2, sd=0.1)) = 2.53
fig4 <- ggplot(data = data.frame(x = c(-5, 5)), aes(x)) +
          stat_function(fun = dnorm, n = 101, args = list(mean = 0, sd = 1), col='red') + ylab("") +
          stat_function(fun = dnorm, n = 101, args = list(mean = 1.5, sd = 0.5), col='blue') + ylab("") +
          xlab(TeX('$R_0$')) + ylab('') +
          annotate('text', label='W%~~%2.53', x=-3, y=0.6, parse=T, size=2.5) +
          theme_minimal()+ 
          theme(axis.text.x = element_text(angle = 60,  hjust=1))

path <- file.path(getwd(), "figs/", "wassComp.pdf")
pdf('figs/wassComp.pdf', useDingbats = F, width=3, height=3)
  cowplot::plot_grid(fig1, fig2, fig3, fig4, ncol=2)
dev.off()
```
\centering
\includegraphics[width=0.9\textheight]{figs/wassComp.pdf}

## Classification 
```{r include=FALSE}
df <- data.frame(Data=c(rep('Date Data',10000), rep('Full Data', 10000), rep('Marginal Prior', 10000), rep('Sequence Data', 10000)),
                 x=c(rnorm(n=10000, mean = 1.5, sd = 0.2),
                     rnorm(n=10000, mean = 2.5, sd = 0.2),
                     rgamma(n=10000, shape=3.5, rate = 2.5),
                     rnorm(n=10000, mean = 3, sd = 0.2)))

dists2 <- ggplot(data = df, aes(x=x, fill=Data)) +
    geom_density() +
     annotate("segment", x = 2.51, xend = 3, y = 1.5, yend = 1.5,
             colour = "black", arrow = arrow(ends = "both", angle = 90, length = unit(.2,"cm"))) +
    annotate("label", x = 2.75, y = 1.5, colour = "black", label='W[S]==0.5', parse=T, fill="#fc8d59") +
  
    annotate("segment", x = 1.5, xend = 2.49, y = 1.5, yend = 1.5,
             colour = "black", arrow = arrow(ends = "both", angle = 90, length = unit(.2,"cm"))) +
    annotate("label", x = 2, y = 1.5, fill="#fc8d59", label='W[D]==1.0', parse=T) +
  
    annotate("segment", x = 1, xend = 2.49, y = 0.4, yend = 0.4,
             colour = "black",arrow = arrow(ends = "both", angle = 90, length = unit(.2,"cm"))) +
    annotate("label", x = 1.75, y = 0.4, colour = "black", label='W[N]==1.15', parse=T) +
  
    #annotate("label", x = 0.6, y = 1, colour = "black", label='W[X]==integral(paste("| ", F[X]^-1*(u)-F[F]^-1*(u), " |")*du, 0, 1)', parse=T) +
    annotate("label", x = 3.5, y = 1, colour = "black", label='W[D]>W[S]%->%Seq~Driven', parse=T) +
  xlim(0,4) +
  scale_fill_manual(values=alpha(viridis(4), 0.5)) +
    xlab(TeX('Posterior $R_{0}$')) + ylab('Density') + 
    coord_fixed() +
    theme_minimal() +
  		theme(legend.position='bottom', 
  			legend.title=element_blank(),
  			legend.text=element_text(size=14), 
  			axis.title=element_text(size=14))


pdf('figs/compPosteriorColoured.pdf', useDingbats = F, width=8, height=4)
  dists2
dev.off()

```
\centering
\includegraphics[width=0.9\textwidth]{figs/compPosteriorColoured.pdf}

## Visualing Wasserstein Data
```{r include=F}
# data plane
trsup <- data.frame(x=c(0,0,4),y=c(0,4,4))
trinf <- data.frame(x=c(0,4,4),y=c(0,0,4))
plane <- ggplot() +
		xlim(0,4) + ylim(0,4) +
		# shade quad 1
		geom_polygon(aes(x=x, y=y), data=trsup, fill=alpha("grey", 0.5)) +
		geom_polygon(aes(x=x, y=y), data=trinf, fill=alpha("white", 0.5)) +
		geom_quadrant_lines(linetype = "solid") +
		coord_fixed(ratio = 1) +
			ylab(TeX('W_{S}')) + xlab(TeX('W_{D}')) +	
			annotate("text", 	x = c(1,3), 
							y = c(3,1), 
			label = c("atop(Date-Driven, (W[S]>W[D]))", 
				"atop(Seq-Driven, (W[S]<W[D]))"), parse=T) +
			theme_minimal() +
      theme(plot.margin = unit(c(0, 0, 0, 0), "cm"))
# data driven e.g.
ddDists <- ggplot(data = data.frame(x = c(0, 4)), aes(x)) +
  stat_function(fun = dnorm, n = 10000, args = list(mean = 1.5, sd = 0.2), 
  	fill=alpha(viridis::viridis(4)[4], 0.5), geom='density') +
  # fulldata
  stat_function(fun = dnorm, n = 10000, args = list(mean = 2.5, sd = 0.2), 
  	fill=alpha(viridis::viridis(4)[2], 0.5), geom='density') +
  # no data
  #stat_function(fun = dgamma, n = 10000, args = list(shape = 3.5, rate = 2.5), 
  #	fill=alpha(viridis::viridis(4)[3], 0.5), geom='density') + ylab("") +
  # seq data
  stat_function(fun = dnorm, n = 10000, args = list(mean = 3, sd = 0.2), 
  	fill=alpha(viridis::viridis(4)[1], 0.5), geom='density') +
    coord_fixed(ratio = 2) +
  xlab(expression(R[0])) + ylab('Posterior Density') +
  annotate("segment", x = 2.45, xend = 3.05, y = 1, yend = 1,
           colour = "black", size = 1, arrow = arrow(ends = "both", angle = 90, length = unit(.2,"cm"))) +
  annotate("label", x = 2.75, y = 1, colour = "black", label='W[D]==0.5', parse=T) +

  annotate("segment", x = 1.5, xend = 2.49, y = 1.5, yend = 1.5,
           colour = "black", size = 1, arrow = arrow(ends = "both", angle = 90, length = unit(.2,"cm"))) +
  annotate("label", x = 2, y = 1.5, colour = "black", label='W[S]==1.0', parse=T) +
  theme(plot.margin = unit(c(0, 0, 0, 0), "cm"))

# seq-driven eg
sdDists <- ggplot(data = data.frame(x = c(0, 4)), aes(x)) +
  stat_function(fun = dnorm, n = 10000, args = list(mean = 1.5, sd = 0.2), 
  	fill=alpha(viridis::viridis(4)[1], 0.5), geom='density') +
  # fulldata
  stat_function(fun = dnorm, n = 10000, args = list(mean = 2.5, sd = 0.2), 
  	fill=alpha(viridis::viridis(4)[2], 0.5), geom='density') +
  # seq data
  stat_function(fun = dnorm, n = 10000, args = list(mean = 3, sd = 0.2), 
  	fill=alpha(viridis::viridis(4)[4], 0.5), geom='density') +
    coord_fixed(ratio = 2) +
  theme_minimal() +
  xlab(expression(R[0])) + ylab('Posterior Density') +
  annotate("segment", x = 2.45, xend = 3.05, y = 1, yend = 1,
           colour = "black", size = 1, arrow = arrow(ends = "both", angle = 90, length = unit(.2,"cm"))) +
  annotate("label", x = 2.75, y = 1, colour = "black", label='W[S]==0.5', parse=T) +

  annotate("segment", x = 1.5, xend = 2.49, y = 1.5, yend = 1.5,
           colour = "black", size = 1, arrow = arrow(ends = "both", angle = 90, length = unit(.2,"cm"))) +
  annotate("label", x = 2, y = 1.5, colour = "black", label='W[D]==1.0', parse=T) +
  theme(plot.margin = unit(c(0, 0, 0, 0), "cm"))

# sd point plane
sdPlane <- ggplot() +
		xlim(0,4) + ylim(0,4) +
		# shade quad 1
		geom_polygon(aes(x=x, y=y), data=trsup, fill=alpha("grey", 0.5)) +
		geom_polygon(aes(x=x, y=y), data=trinf, fill=alpha("white", 0.5)) +
		geom_quadrant_lines(linetype = "solid") +
    annotate(geom='point', x=1, y=0.5, pch=21, fill=alpha(viridis(4)[4],0.5), size=2.5) +
		coord_fixed(ratio = 1) +
			ylab(TeX('W_{S}')) + xlab(TeX('W_{D}')) +	
			annotate("text", 	x = c(1,3), 
							y = c(3,1), 
			label = c("atop(Date-Driven, (W[S]>W[D]))", 
				"atop(Seq-Driven, (W[S]<W[D]))"), parse=T) +
			theme_minimal() +
      theme(plot.margin = unit(c(0, 0, 0, 0), "cm"))

# dd point plane
sdddPlane <- ggplot() +
		xlim(0,4) + ylim(0,4) +
		# shade quad 1
		geom_polygon(aes(x=x, y=y), data=trsup, fill=alpha("grey", 0.5)) +
		geom_polygon(aes(x=x, y=y), data=trinf, fill=alpha("white", 0.5)) +
		geom_quadrant_lines(linetype = "solid") +
    annotate(geom='point', x=1, y=0.5, pch=21, fill=alpha(viridis(4)[4],0.5), size=2.5) +
    annotate(geom='point', x=0.5, y=1, pch=21, fill=alpha(viridis(4)[1],0.5) , size=2.5) +
		coord_fixed(ratio = 1) +
			ylab(TeX('W_{S}')) + xlab(TeX('W_{D}')) +	
			annotate("text", 	x = c(1,3), 
							y = c(3,1), 
			label = c("atop(Date-Driven, (W[S]>W[D]))", 
				"atop(Seq-Driven, (W[S]<W[D]))"), parse=T) +
			theme_minimal() +
      theme(plot.margin = unit(c(0, 0, 0, 0), "cm"))

# attempt legend
#tmp <- data.frame(col=alpha(viridis::viridis(4)[c(2,1,4)], 0.5), x=1:3, y=3:1)
#ggplot(tmp, aes(x=1,y=y,col=col)) + geom_point() + scale_color_manual(values=tmp$col, values=)

#plot(NULL ,xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
#legend('topleft', col=alpha(viridis::viridis(4)[c(2,1,4)], 0.5), legend=c('Full Data', 'Date Data', 'Sequence Data'),
#       pch=16, pt.cex=3, cex=1.5, bty='n')

# legend
df <- data.frame(x=1:3, y=1:3, col=c('Date Data', 'Full Data', 'Sequence Data'))
leg <- cowplot::get_legend(ggplot(df) + geom_point(aes(x=x, y=y, fill=col), shape=21, size=8) + scale_fill_manual(values=alpha(viridis(4)[c(1,2,4)], 0.5)) + 
  theme_minimal() + theme(legend.title = element_blank()))

emp <- ggplot() + theme_void()

  egg::ggarrange(emp, emp,
          plane, emp,
          ncol = 2) %>%
  ggpubr::ggexport(filename = "figs/wassEg1.pdf")

  egg::ggarrange(emp, emp,
          sdPlane, sdDists,
          ncol = 2) %>%
  ggpubr::ggexport(filename = "figs/wassEg2.pdf")

    egg::ggarrange(ddDists, emp,
          sdddPlane, sdDists,
          ncol = 2) %>%
  ggpubr::ggexport(filename = "figs/wassEg3.pdf")

```
<!--![Diagonal is classification boundary](figs/wassEg1.pdf)-->
<!--img src="figs/wassEg1.pdf" width="200" height="200" /-->
\centering
\includegraphics[width=0.9\textheight]{figs/wassEg1.pdf}

## Visualing Wasserstein Data 
<!--![tmp](figs/wassEg2.pdf)-->
<!--img src="figs/wassEg2.pdf" width="200" height="200" /-->
\centering
\includegraphics[width=0.9\textheight]{figs/wassEg2.pdf}

## Visualing Wasserstein Data
<!--![tmp](figs/wassEg3.pdf)-->
<!--img src="figs/wassEg3.pdf" width="200" height="200" /-->
\centering
\includegraphics[width=0.9\textheight]{figs/wassEg3.pdf}

## Validation: Simulation study
```{r include=FALSE}
treeSim <- "Simulated outbreaks, 100 cases\n(n=100)"
samp <- 'Sample outbreaks w.p. 0.5 and 1 \n(n=200)'
rate <- 'Simulate sequence data  \nrate 10^-3 and 10^-5 (subs/site/yr)\n(n=400 Test datasets)'

fig <-  grViz("
          digraph simFlow {
          
          # node definitions with substituted label text
          node [shape = box, fontname = Helvetica]
          # 100 trees
          a [label = '@@1']
          # samp p = 1 and 0.5
          b [label = '@@2']
          # sim rate
          c [label = '@@3']
          
          # edge definitions with the node IDs
          a -> b -> c 
          }
          [1]: treeSim
          [2]: samp
          [3]: rate
        ")
fig = DiagrammeRsvg::export_svg(fig)
fig = charToRaw(fig) # flatten
rsvg::rsvg_pdf(fig, "figs/simStudy.pdf")
```
\centering
\includegraphics[width=0.9\textheight]{figs/simStudy.pdf}

## On the plane
```{r include=FALSE}
library(ggpmisc)
library(ggExtra)
load('../datePatterns.RData')
load('../sitePatterns.RData')
load('../combinedData.Rdata')

trsup <- data.frame(x=c(0,0,1),y=c(0,1,1))
trinf <- data.frame(x=c(0,1,1),y=c(0,0,1))

p1 <-	ggplot(dat, aes(x=abs(dateDataW), y=abs(seqDataW))) +
		xlim(0,1) + ylim(0,1) +
		# shade quad 1
		geom_polygon(aes(x=x, y=y), data=trsup, fill=alpha("grey", 0.5)) +
		geom_polygon(aes(x=x, y=y), data=trinf, fill=alpha("white", 0.5)) +
		geom_quadrant_lines(linetype = "solid") +
		coord_fixed(ratio = 1) +
		geom_point(pch=21, size=2.5, fill=alpha('dodgerblue', 0.7)) +
			geom_quadrant_lines(linetype = "solid") +
			xlab(TeX('W_{D}')) + ylab(TeX('W_{S}')) +	
			annotate("text", 	x = c(0.5, 0.85), 
							y = c(0.85,0.5), 
			label = c("Date-Driven", "Seq-Driven"), size=5) +
			theme_minimal() +
			guides(fill = guide_colourbar(ticks = F)) +
			theme(legend.position='bottom', 
				legend.title=element_text(size=14),
				legend.text=element_text(size=14),
				axis.title=element_text(size=14),
				axis.text=element_text(size=12))
p1 <-  ggMarginal(p1, size=7, type='histogram', fill=alpha('dodgerblue', 0.6))
p1 %>% ggpubr::ggexport(filename = "figs/wassDist.pdf")
```
\centering
\includegraphics[width=0.9\textheight]{figs/wassDist.pdf}

## Effects of Sequence Patterns
```{r include=F}
p2 <- ggplot(dat, aes(x=abs(dateDataW), y=abs(seqDataW), fill=as.numeric(sitePatterns))) +
		xlim(0,1) + ylim(0,1) +
		# shade quad 1
		geom_polygon(aes(x=x, y=y), data=trsup, fill=alpha("grey", 0.5)) +
		geom_polygon(aes(x=x, y=y), data=trinf, fill=alpha("white", 0.5)) +
		geom_quadrant_lines(linetype = "solid") +
		geom_point(pch=21, size=2.5) +
		coord_fixed(ratio = 1) +
		scale_fill_continuous(name='Site Patterns', type='viridis', breaks = seq(0,800, by=200)) +
		xlab(TeX('W_{D}')) + ylab(TeX('W_{S}')) +
		annotate("text", 	x = c(0.5, 0.85), 
							y = c(0.85,0.5), 
			label = c("Date-Driven", "Seq-Driven"), size=5) +
		theme_minimal() +
		theme(legend.position='bottom', 
			legend.title=element_text(size=14),
			axis.title=element_text(size=14),
			axis.text=element_text(size=12))
p2 %>% ggpubr::ggexport(filename = "figs/wassDistSeqPatts.pdf")
```
\centering
\includegraphics[width=0.9\textheight]{figs/wassDistSeqPatts.pdf}

## Effects of Date Span
``` {r include=F}
p3 <- ggplot(dat, aes(x=abs(dateDataW), y=abs(seqDataW), fill=as.numeric(datePatterns))) +
		xlim(0,1) + ylim(0,1) +
		# shade quad 1
		geom_polygon(aes(x=x, y=y), data=trsup, fill=alpha("grey", 0.5)) +
		geom_polygon(aes(x=x, y=y), data=trinf, fill=alpha("white", 0.5)) +
		geom_quadrant_lines(linetype = "solid") +
		geom_point(pch=21, size=2.5) +
		coord_fixed(ratio = 1) +
		scale_fill_continuous(name='Relative Date Span', type='viridis') +
		xlab(TeX('W_{D}')) + ylab(TeX('W_{S}')) +
		#annotate("segment", x = -1, xend = 1, y = -1, yend = 1, colour = "black", lty=2) +
		#annotate("segment", x = -1, xend = 1, y = 1, yend = -1, colour = "black", lty=2) +
		annotate("text", 	x = c(0.5, 0.85), 
							y = c(0.85,0.5), 
			label = c("Date-Driven", "Seq-Driven"), size=5) +
		theme_minimal() +
		theme(legend.position='bottom', 
			legend.title=element_text(size=14),
			axis.title=element_text(size=14),
			axis.text=element_text(size=12))
p3 %>% ggpubr::ggexport(filename = "figs/wassDistDatPatts.pdf")
```
\centering
\includegraphics[width=0.9\textheight]{figs/wassDistDatPatts.pdf}

## Method summary
>1. Separate date an sequence data
>2. Analyse both under a birth-death
>3. Compare posteriors with Wasserstein metric to find drivers
>4. Driver-classification agrees with prior literature on BD 

## Results in context
\begin{figure}
\centering
\includegraphics[height=0.9\textheight]{figs/early2021SampEg.pdf}
<!--\caption{Cumulative sampling and case trajectory from early 2021 in Australia.}-->
\end{figure}

## Results in context
\centering
\includegraphics[height=0.9\textheight]{figs/whole2021SampEg.pdf}

<!-- Slide N-1 -->
## Acknowledgements 
<!-- plot icons ? -->
> - cEvo lab & Swissnex
> - Lionell Gell Foundation 
> - Wonderful supervisors!

<!-- Slide N-->
## All questions welcome 

## References
1) Volz Erik M. and Frost Simon D. W. 2014Sampling through time and phylodynamic inference with coalescent and birth–death models J. R. Soc. Interface.112014094520140945 \url{http://doi.org/10.1098/rsif.2014.0945} Section A

2) Featherstone, LA, Di Giallonardo, F, Holmes, EC, Vaughan, TG, Duchêne, S. Infectious disease phylodynamics with occurrence data. Methods Ecol Evol. 2021; 12: 1498– 1507. \url{https://doi.org/10.1111/2041-210X.13620}

## Sampling effects
```{r include=F}
source('../ggSplitViolin.R')
newDat <- dat %>% pivot_longer(ends_with("DataW"), values_to='wasserstein', names_to='type', values_drop_na=T)

p4 <- ggplot(subset(newDat, type!='noDataW'), aes(x=sampProp, y=wasserstein, fill=(type))) +
		geom_split_violin() +
		#scale_y_continuous(breaks=seq(0,1,by=0.25), limits=c(0,1)) +
		scale_fill_manual(values=alpha(viridis(2), 0.8), labels=c(expression(W[D]), expression(W[S]))) +
		xlab('Sampling Proportion') + ylab(expression(W[D]~or~W[S])) +
		theme_minimal() +
		theme(legend.position='bottom', 
			legend.title=element_blank(),
			legend.text=element_text(size=14), 
			axis.title=element_text(size=14),
			axis.text=element_text(size=12)) +
		coord_fixed(ratio = 1) 
p4 %>% ggpubr::ggexport(filename = "figs/wassDistSampling.pdf")
```
\centering
\includegraphics[width=0.9\textheight]{figs/wassDistSampling.pdf}

## Empirical Data
>- Two SARS-CoV-2 clusters from 2020 in Victoria, Australia 
>- Fixed parameters except origin and $R_{0}$

## Empirical Data: Posteriors
\centering
\includegraphics[width=0.9\textheight]{../figures/empPosteriorR0.pdf}

## Empirical Data: Values

|       | Cluster 1   | Cluster 2   |  
| ------| ----------- | ------------ | 
|   n   | 112         | 188         |             
|Classification      |   Seq-Driven     |    Date-Driven   |
| Site Patterns | 183 | 126 |
|$r_{SD}$   |   0.223     |   0.009         |
|$d_{SD}$    |    0.078    |    0.008     |
|$W_{D}$       |  0.192       |  0.001       |
|$W_{S}$        | 0.114      |0.009        |
|$W_{N}$      |0.325         | 0.481        |



## Strength of Classification
```{r include=F}
trsup <- data.frame(x=c(0,0,1.2),y=c(0,1.2,1.2))
trinf <- data.frame(x=c(0,1.2,1.2),y=c(0,0,1.2))
p1 <- ggplot() +
		xlim(0,1.2) + ylim(0,1.2) +
		# shade quad 1
		geom_polygon(aes(x=x, y=y), data=trsup, fill=alpha("grey", 0.5)) +
		geom_polygon(aes(x=x, y=y), data=trinf, fill=alpha("white", 0.5)) +
		geom_quadrant_lines(linetype = "solid") +
		coord_fixed(ratio = 1) +
			ylab(TeX('W_{S}')) + xlab(TeX('W_{D}')) +	
			annotate("text", 	x = c(0.2,1.1), 
							y = c(1.1,0.2), 
			label = c("atop(Date-Driven, (W[S]>W[D]))", 
				"atop(Seq-Driven, (W[S]<W[D]))"), size=5, parse=T) +
		# point example 
		annotate('segment', x=0, y=0, xend=0.5, yend=0.1) +
		annotate('segment', x=0.5, y=0.1, xend=0.5, yend=0.5) +
		annotate('point', x=0.5, y=0.1, size=1.5) +
		annotate('text', parse=T, x=0.65, y=0.1, label='paste("(", 0.5,",", ~0.1,")")') +
		annotate('text', parse=T, x=0.25, y=0.1, size=4, angle=180*(atan(0.1/0.5)/pi), label="r[SD]==0.51") +
		annotate('text', parse=T, x=0.65, y=0.25, size=4, label="d[SD]==0.4") +
		annotate("label", x = 0.825, y = 0.85, colour = "black", label='r[SD]==sqrt(W[S]^2+W[D]^2)', parse=T, size=5) +
		annotate("label", x = 0.825, y = 0.75, colour = "black", label='d[SD]==abs(W[S]-W[D])', parse=T, size=5) +
			theme_minimal() +
			theme(legend.position='bottom', 
				legend.title=element_text(size=14),
				legend.text=element_text(size=14),
				axis.title=element_text(size=14),
				axis.text=element_text(size=12))

pdf('figs/fullPlane.pdf', useDingbats = F)
  p1
dev.off()
```
\centering
\includegraphics[width=0.9\textheight]{figs/fullPlane.pdf}

## Error
\centering
\includegraphics[width=0.9\textheight]{../figures/errorWasserstein.pdf}





